<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piles Calculator Advanced - Model 0.95</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Three.js Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/renderers/CSS2DRenderer.js"></script>
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-body: linear-gradient(to bottom right, #f3f4f6, #e5e7eb);
            --bg-main: rgba(255, 255, 255, 0.9);
            --text-main: #1F2937;
            --text-secondary: #4b5563;
            --border-color: #D1D5DB;
            --section-border: #4F46E5;
            --result-bg: #EFF6FF;
            --result-border: #BFDBFE;
            --result-title-text: #1E40AF;
            --result-value-text: #1D4ED8;
            --solution-step-bg: #f9fafb;
            --tab-active-bg: #ffffff;
            --tab-inactive-bg: #e5e7eb;
            --tab-active-text: #4F46E5;
            --tab-inactive-text: #4b5563;
            --header-controls-bg: rgba(229, 231, 235, 0.5);
            --highlight-bg: #fefce8;
            --highlight-text: #a16207;
            --highlight-border: #facc15;
            --summary-box-bg: #fafafa;
            --summary-box-border: #e5e5e5;
            --chart-grid-color: rgba(0, 0, 0, 0.1);
            --chart-font-color: #6b7280;
        }
        .dark {
            --bg-body: linear-gradient(to bottom right, #000000, #111827, #1F2937);
            --bg-main: rgba(31, 41, 55, 0.85);
            --text-main: #E5E7EB;
            --text-secondary: #9CA3AF;
            --border-color: #4B5563;
            --section-border: #818CF8;
            --result-bg: #1E3A8A;
            --result-border: #3B82F6;
            --result-title-text: #DBEAFE;
            --result-value-text: #ffffff;
            --solution-step-bg: #2d3748;
            --tab-active-bg: #1F2937;
            --tab-inactive-bg: #111827;
            --tab-active-text: #A5B4FC;
            --tab-inactive-text: #9CA3AF;
            --header-controls-bg: rgba(55, 65, 81, 0.5);
            --highlight-bg: #422006;
            --highlight-text: #fef3c7;
            --highlight-border: #facc15;
            --summary-box-bg: #2a374a;
            --summary-box-border: #4b5563;
            --chart-grid-color: rgba(255, 255, 255, 0.1);
            --chart-font-color: #9ca3af;
        }
        
        html { scroll-behavior: smooth; }
        body { 
            font-family: 'Assistant', sans-serif; 
            background-color: #f3f4f6;
            color: var(--text-main);
            transition: background-color 0.3s ease, color 0.3s ease;
            position: relative;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .body-bg-container {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-image: var(--bg-body);
            z-index: -10;
        }
        .body-bg-container::before, .body-bg-container::after {
            content: '';
            position: fixed;
            bottom: 0;
            z-index: -1;
            opacity: 0.3;
            background-size: contain;
            background-repeat: no-repeat;
            transition: opacity 0.3s ease;
        }
        .body-bg-container::before {
            background-image: url('https://i.postimg.cc/26SmSx5d/614e67fa-c4aa-401e-b070-b26336cbda87.png');
            left: -50px;
            bottom: -50px;
            width: 400px;
            height: 400px;
            background-position: left bottom;
        }
        .body-bg-container::after {
            background-image: url('https://i.postimg.cc/5yHVwNL6/a6d1ee98-3bd9-4dde-9937-783a6d366e08.png');
            right: -50px;
            bottom: -20px;
            width: 350px;
            height: 350px;
            background-position: right bottom;
        }
        .dark .body-bg-container::before, .dark .body-bg-container::after {
            opacity: 0.2;
            filter: invert(1);
        }

        .main-content-box { 
            background-color: var(--bg-main); 
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: var(--text-main); 
            border-radius: 0.75rem; 
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transition: background-color 0.3s ease, color 0.3s ease; 
            position: relative;
            z-index: 1;
        }
        .main-content-box::before {
            content: '';
            position: absolute;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            width: 250px;
            height: 250px;
            background-image: url('https://i.postimg.cc/HscYM39B/501f8c30-383c-4d60-8744-b9e1f83993fb.png');
            background-size: contain;
            background-repeat: no-repeat;
            opacity: 0.25;
            z-index: -1;
            transition: opacity 0.3s ease, filter 0.3s ease;
        }
        .dark .main-content-box::before {
             opacity: 0.15;
             filter: invert(1) brightness(1.5);
        }
        
        header.main-header {
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            position: relative;
        }

        .header-controls { display: flex; flex-direction: column; align-items: flex-start; gap: 0.5rem; z-index: 10; }
        .header-controls-row { display: flex; gap: 0.75rem; align-items: center; }

        .control-btn { background: var(--header-controls-bg); backdrop-filter: blur(4px); border: 1px solid var(--border-color); border-radius: 9999px; padding: 0.5rem; cursor: pointer; transition: all 0.3s ease; color: var(--text-main); display:flex; align-items:center; justify-content:center; }
        .control-btn:hover { transform: scale(1.1); }
        .learn-mode-toggle { display: flex; align-items: center; gap: 0.5rem; background-color: var(--header-controls-bg); border: 1px solid var(--border-color); border-radius: 9999px; padding: 0.3rem; }
        #learn-mode-checkbox { appearance: none; width: 3.5rem; height: 1.75rem; background-color: var(--border-color); border-radius: 9999px; position: relative; cursor: pointer; transition: background-color 0.3s ease; }
        #learn-mode-checkbox::before { content: ''; position: absolute; width: 1.25rem; height: 1.25rem; border-radius: 50%; background-color: white; top: 0.25rem; left: 0.25rem; transition: transform 0.3s ease; }
        #learn-mode-checkbox:checked { background-color: #4f46e5; }
        #learn-mode-checkbox:checked::before { transform: translateX(1.75rem); }
        .unit-toggle { display: flex; align-items: center; background-color: var(--header-controls-bg); border: 1px solid var(--border-color); border-radius: 9999px; padding: 0.25rem; cursor: pointer; transition: all 0.3s ease; }
        .unit-toggle span { padding: 0.25rem 0.75rem; font-size: 0.8rem; font-weight: 600; border-radius: 9999px; transition: all 0.3s ease; }
        .unit-toggle.kpa-active .kpa-unit { background-color: #3b82f6; color: white; }
        .unit-toggle.ton-active .ton-unit { background-color: #ef4444; color: white; }

        .section-title { font-size: 1.5rem; font-weight: 600; color: var(--text-main); border-bottom: 2px solid var(--section-border); padding-bottom: 0.5rem; margin-bottom: 1.25rem; }
        .input-label { display: flex; align-items: center; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.4rem; font-size: 1.05rem; }
        .learn-mode-active .input-label[data-learn-key],
        .learn-mode-active .learn-icon { cursor: help; }
        .learn-mode-active .input-label[data-learn-key]:hover { color: var(--tab-active-text); }
        .input-field, .select-field { width: 100%; padding: 0.7rem 0.9rem; border: 1px solid var(--border-color); background-color: var(--bg-main); color: var(--text-main); border-radius: 0.375rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); transition: all 0.2s ease-in-out; font-size: 1.05rem; }
        .input-field:focus, .select-field:focus { outline: 2px solid transparent; outline-offset: 2px; border-color: #6366F1; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3); }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.375rem; font-weight: 600; transition: all 0.15s ease-in-out; font-size: 1.05rem; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;}
        .btn-primary { background-color: #4F46E5; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #4338CA; }
        .btn-danger { background-color: #EF4444; color: white; }
        .btn-danger:hover:not(:disabled) { background-color: #DC2626; }
        .result-box { background-color: var(--result-bg); border: 1px solid var(--result-border); padding: 1.25rem; border-radius: 0.5rem; margin-top: 1rem; }
        .result-value { font-weight: 700; color: var(--result-value-text); font-size: 1.5rem; opacity: 0; transform: translateY(10px); transition: opacity 0.5s ease-out, transform 0.5s ease-out; }
        .result-value.visible { opacity: 1; transform: translateY(0); }
        
        #canvas-3d-container { 
            border: 1px solid var(--border-color); 
            border-radius: 0.375rem; 
            width: 100%; 
            min-height: 450px;
            height: 60vh;
            cursor: move; 
            position:relative; 
            overflow: hidden;
        }
        .label {
            color: var(--text-main);
            font-family: 'Assistant', sans-serif;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 4px;
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            font-size: 12px;
            text-align: right;
            white-space: nowrap;
        }
        .dark .label {
             background: rgba(31, 41, 55, 0.8);
             border-color: #4b5563;
        }
        .label-title {
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 2px;
            margin-bottom: 2px;
        }

        .charts-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        .chart-box {
            background-color: var(--bg-main);
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            height: 450px; /* Increased height */
        }
        .chart-explainer-btn {
            display: none;
            margin-top: 0.5rem;
            font-size: 0.8rem;
            text-decoration: underline;
            cursor: help;
            color: var(--tab-active-text);
        }
        .learn-mode-active .chart-explainer-btn {
            display: block;
        }

        .tab-button { padding: 0.75rem 1rem; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s ease; background-color: var(--tab-inactive-bg); color: var(--tab-inactive-text); font-size: 0.9rem; text-align: center;}
        .tab-button.active { border-bottom-color: var(--section-border); background-color: var(--tab-active-bg); color: var(--tab-active-text); }
        .tab-content { display: none; padding-top: 1.5rem; }
        .tab-content.active { display: block; }
        .solution-step { background-color: var(--solution-step-bg); border: 1px solid var(--border-color); padding: 1.25rem; border-radius: 0.5rem; margin-bottom: 1.5rem; }
        .solution-step-title { font-size: 1.4rem; font-weight: 600; color: var(--text-main); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color); }
        .formula-box { background-color: #eef2ff; border-right: 4px solid #4f46e5; margin: 1rem 0; padding: 1.25rem; direction: ltr; text-align: left; overflow-x: auto; border-radius: 0.375rem; }
        .dark .formula-box { background-color: #3730a3; border-right-color: #a5b4fc; }
        .formula { font-family: 'Georgia', 'Times New Roman', serif; color: #1e3a8a; font-size: 1.3rem; display: block; white-space: pre-wrap; word-wrap: break-word; }
        .dark .formula { color: #e0e7ff;}
        
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0s 0.3s; }
        .modal.visible { opacity: 1; visibility: visible; transition: opacity 0.3s; }
        .modal-content { background: var(--bg-main); padding: 2rem; border-radius: 0.5rem; max-width: 90vw; max-width: 600px; text-align: right; max-height: 90vh; overflow-y: auto; position: relative;}
        .modal-close-btn { position: absolute; top: 0.5rem; left: 0.5rem; right: auto; background: transparent; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-main); }
        .soil-layer { background-color: #f8fafc; border: 1px solid #e5e7eb; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; position: relative; }
        .dark .soil-layer { background-color: #2d3748; border-color: #4b5563; }
        .layer-header { font-weight: 600; margin-bottom: 0.75rem; display: flex; justify-content: space-between; align-items: center; }
        .layer-radio-label { display: flex; align-items: center; cursor: pointer; font-size: 0.9em; font-weight: normal; }
        .legend-details { margin-top: 1rem; font-size: 0.9rem; }
        .legend-details summary { cursor: pointer; font-weight: 500; color: var(--text-secondary); }
        .legend-details summary:hover { color: var(--text-main); }
        .legend-content li { margin-bottom: 0.25rem; }
        .legend-content .formula-variable { cursor: help; font-family: 'Times New Roman', Times, serif; font-style: italic; color: #4f46e5; font-weight: bold; }
        .dark .legend-content .formula-variable { color: #a5b4fc; }
        .highlighted-result { background-color: var(--highlight-bg); color: var(--highlight-text); padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-weight: bold; border: 1px solid var(--highlight-border); }
        .learn-icon { position: absolute; top: 10px; left: 10px; z-index: 5; background-color: rgba(79, 70, 229, 0.8); color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-family: serif; font-weight: bold; font-size: 1.1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: all 0.2s ease; }
        .learn-icon:hover { transform: scale(1.1); background-color: #4338ca; }
        .summary-box { background-color: var(--summary-box-bg); border: 1px solid var(--summary-box-border); padding: 1rem; border-radius: 0.5rem; margin-top: 1.5rem; }
        .summary-box p { margin-bottom: 0.5rem; }
        .summary-box .summary-label { font-weight: 500; color: var(--text-secondary); }
        .summary-box .summary-value { font-weight: 600; color: var(--text-main); }
        .theory-table { width: 100%; margin-top: 1rem; border-collapse: collapse; }
        .theory-table th, .theory-table td { border: 1px solid var(--border-color); padding: 0.5rem; text-align: center; }
        .theory-table th { background-color: #eef2ff; }
        .dark .theory-table th { background-color: #312e81; }
        #pdf-export-content { display: none; }

        /* Styles for embedded guide */
        #guide-content-wrapper { font-family: 'Assistant', sans-serif; }
        #guide-content-wrapper .content-section { display: none; }
        #guide-content-wrapper .content-section.active { display: block; }
        #guide-content-wrapper .tab-content { display: none; }
        #guide-content-wrapper .tab-content.active { display: block; }
        #guide-content-wrapper .sub-nav-content { display: none; }
        #guide-content-wrapper .sub-nav-content.active { display: block; }
        #guide-content-wrapper .sub-nav-item.active { background-color: #e9ecef; font-weight: 700; }
        #guide-content-wrapper .main-nav-item.active { background-color: #003366; color: white; }
        #guide-content-wrapper .tab-button.active { background-color: #003366; color: white; border-color: #003366; }
        #guide-content-wrapper .chart-container { position: relative; width: 100%; max-width: 600px; margin-left: auto; margin-right: auto; height: 350px; max-height: 40vh; }

    </style>
</head>
<body class="p-4 md:p-8">
    <div class="body-bg-container"></div>
    <div class="main-content-box max-w-screen-2xl mx-auto p-6 md:p-8">
        <header class="main-header">
             <div class="header-controls">
                <div class="header-controls-row">
                    <button id="theme-toggle-btn" class="control-btn" aria-label="Toggle theme">
                        <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.95-4.223-1.591 1.591M5.25 12H3m4.223-4.95L6.364 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" /></svg>
                        <svg id="theme-icon-moon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 hidden"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z" /></svg>
                    </button>
                    <div id="unit-toggle" class="unit-toggle kpa-active" aria-label="Toggle units">
                        <span class="ton-unit">t/m²</span>
                        <span class="kpa-unit">kPa</span>
                    </div>
                </div>
                <div class="header-controls-row">
                     <div class="learn-mode-toggle" aria-label="Toggle Learn Mode">
                        <span class="font-semibold text-sm">מצב לימוד</span>
                        <input type="checkbox" id="learn-mode-checkbox">
                    </div>
                    <button id="theory-btn" class="control-btn" aria-label="Show theory">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
                        </svg>
                    </button>
                    <button id="export-pdf-btn" class="control-btn" aria-label="Export to PDF">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a42.415 42.415 0 0110.56 0m-10.56 0L6.34 18m10.94-4.171c.24.03.48.062.72.096m-.72-.096L17.66 18m0 0l.229 2.523a1.125 1.125 0 01-1.12 1.227H7.231c-.662 0-1.18-.568-1.12-1.227L6.34 18m11.32 0c.662 0 1.18.568 1.12 1.227l-.229 2.523a1.125 1.125 0 01-1.12 1.227H7.231c-.662 0-1.18-.568-1.12-1.227L6.34 18m0 0a3.001 3.001 0 00-2.722 0l-.936 1.03a1.125 1.125 0 00.41 1.858l.28.141a1.125 1.125 0 001.555-.41l.936-1.03m11.32 0a3.001 3.001 0 002.722 0l.936 1.03a1.125 1.125 0 00-.41-1.858l-.28-.141a1.125 1.125 0 00-1.555.41l-.936-1.03" />
                        </svg>
                    </button>
                </div>
            </div>
            <div class="text-center">
                <h1 class="text-3xl md:text-4xl font-bold text-indigo-700 dark:text-indigo-400">Piles Calculator Advanced</h1>
                <p class="text-gray-500 dark:text-gray-400 mt-2 text-base">Model 0.95 - Final Candidate</p>
            </div>
            <img src="https://i.postimg.cc/j28gPPbw/Whats-App-2025-06-12-00-52-49-f414dbe7.jpg" alt="לוגו" class="h-16 w-16 md:h-20 md:w-20 rounded-full shadow-md">
        </header>

        <div class="border-b border-gray-300 dark:border-gray-600 mb-4">
            <nav class="flex flex-wrap -mb-px">
                <button class="tab-button active" data-tab="calculation-tab">חישוב הנדסי</button>
                <button class="tab-button" data-tab="solution-tab">מהלך פתרון</button>
                <button class="tab-button" data-tab="cost-tab">הערכת עלויות</button>
                <button class="tab-button" data-tab="guide-tab">מדריך לתכן</button>
            </nav>
        </div>
        
        <main>
            <!-- Calculation Tab -->
            <div id="calculation-tab" class="tab-content active">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-x-8 md:gap-x-10 gap-y-8">
                    <div class="space-y-6">
                        <!-- Pile Geometry -->
                        <div>
                            <h2 class="section-title">גיאומטריית הכלונס</h2>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-5">
                                <div>
                                    <label for="pile_diameter" class="input-label" data-learn-key="pile_diameter">קוטר כלונס (D) [ס"מ]</label>
                                    <input type="number" id="pile_diameter" value="60" class="input-field">
                                </div>
                                <div>
                                    <label for="friction_ignore_depth" class="input-label" data-learn-key="friction_ignore_depth">התעלמות מחיכוך עליון [מ']</label>
                                    <input type="number" id="friction_ignore_depth" value="2" step="0.5" class="input-field">
                                </div>
                                <div class="sm:col-span-2">
                                    <label for="concrete_density" class="input-label" data-learn-key="concrete_density">משקל מרחבי של בטון (<span id="gamma_c_unit_label">kN/m³</span>)</label>
                                    <input type="number" id="concrete_density" value="25" class="input-field">
                                </div>
                            </div>
                        </div>

                        <!-- Soil Layers -->
                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="section-title !mb-0 !border-b-0">שכבות קרקע</h2>
                                <button id="add-layer-btn" class="btn btn-primary text-sm !py-2 !px-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                    הוסף שכבה
                                </button>
                            </div>
                            <div id="soil-layers-container" class="space-y-4">
                                <!-- Soil layers will be dynamically inserted here -->
                            </div>
                        </div>
                        
                        <button id="calculateButton" class="w-full btn btn-primary mt-6">חשב תסבולת מותרת</button>
                    </div>

                    <!-- Right Column -->
                    <div class="space-y-8">
                        <div id="canvas-3d-container">
                             <!-- 3D Scene will be injected here -->
                        </div>
                        <div class="charts-container">
                            <div class="chart-box">
                                <canvas id="friction-graph"></canvas>
                                <div class="text-center">
                                    <button class="chart-explainer-btn" data-learn-key="friction_graph_explanation">מה הגרף הזה מציג?</button>
                                </div>
                            </div>
                             <div class="chart-box">
                                <canvas id="capacity-graph"></canvas>
                                 <div class="text-center">
                                    <button class="chart-explainer-btn" data-learn-key="capacity_graph_explanation">מה הגרף הזה מציג?</button>
                                </div>
                            </div>
                        </div>
                        <div id="summary-box-container"></div>
                        <div id="resultsBox" class="result-box hidden">
                            <h2 class="section-title !mb-5">תוצאות החישוב</h2>
                            <div id="resultsContent" class="space-y-4">
                                <div>
                                    <p class="result-title flex items-center">תסבולת מותרת של הכלונס (F<sub>ser</sub>):</p>
                                    <p id="f_ser_output" class="result-value">-</p>
                                </div>
                                <hr class="my-2 border-t border-blue-200 dark:border-blue-800">
                                <div>
                                    <p class="text-sm text-gray-700 dark:text-gray-300">פירוט תרומות:</p>
                                    <p id="friction_contrib_output" class="text-sm text-gray-600 dark:text-gray-400">-</p>
                                    <p id="tip_contrib_output" class="text-sm text-gray-600 dark:text-gray-400">-</p>
                                    <p id="weight_contrib_output" class="text-sm text-gray-600 dark:text-gray-400">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Solution Tab -->
            <div id="solution-tab" class="tab-content">
                <div id="solution-steps-container">
                    <div class="text-center p-8 text-gray-500">
                        <p>בצע חישוב בלשונית "חישוב הנדסי" כדי להציג את מהלך הפתרון המפורט.</p>
                    </div>
                </div>
            </div>
            
            <!-- Cost Tab -->
            <div id="cost-tab" class="tab-content">
                <h2 class="section-title">הערכת עלויות בסיסית</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-6">
                        <h3 class="text-xl font-semibold">הזנת מחירי יחידה</h3>
                        <div>
                            <label for="drilling_cost" class="input-label">מחיר למטר קידוח (₪)</label>
                            <input type="number" id="drilling_cost" value="150" class="input-field">
                        </div>
                        <div>
                            <label for="concrete_cost" class="input-label">מחיר לקוב בטון (₪)</label>
                            <input type="number" id="concrete_cost" value="450" class="input-field">
                        </div>
                        <button id="calculateCostBtn" class="w-full btn btn-primary">חשב עלות</button>
                    </div>
                    <div id="cost-results-box" class="result-box">
                        <h3 class="section-title !mb-5">פירוט עלויות מוערך</h3>
                        <div class="space-y-4">
                            <div>
                                <p class="result-title">עלות קידוח:</p>
                                <p id="drilling_cost_output" class="result-value">-</p>
                            </div>
                            <hr class="my-2 border-t border-blue-200 dark:border-blue-800">
                            <div>
                                <p class="result-title">עלות בטון:</p>
                                <p id="concrete_cost_output" class="result-value">-</p>
                            </div>
                             <hr class="my-2 border-t border-blue-200 dark:border-blue-800">
                            <div>
                                <p class="result-title font-bold text-lg">עלות כוללת מוערכת:</p>
                                <p id="total_cost_output" class="result-value text-2xl font-bold">-</p>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-4">הערה: העלות המוצגת היא הערכה גסה בלבד ואינה כוללת עלויות נלוות כגון פינוי עודפי עפר, עלות פלדת הזיון, בקרת איכות ועוד.</p>
                    </div>
                </div>
            </div>

            <!-- Guide Tab -->
            <div id="guide-tab" class="tab-content">
                <div id="guide-content-wrapper">
                    <!-- Embedded Guide Content Will Go Here -->
                </div>
            </div>
        </main>
    </div>
    
    <footer class="text-center text-xs text-gray-500 dark:text-gray-400 py-4">
        &copy; 2024 שלומי שאול. כל הזכויות שמורות. לשימוש לימודי בלבד.
    </footer>

    <!-- Modals -->
    <div id="alert-modal" class="modal">
        <div class="modal-content">
            <button id="alert-modal-close" class="modal-close-btn">&times;</button>
            <p id="alert-modal-text" class="text-lg"></p>
        </div>
    </div>
    <div id="image-modal" class="modal">
        <div class="modal-content relative !max-w-4xl">
            <img id="modal-image" src="" alt="Enlarged View">
            <button class="modal-close-btn absolute top-2 right-2">&times;</button>
        </div>
    </div>
    <div id="learn-modal" class="modal">
        <div class="modal-content">
            <button id="learn-modal-close" class="modal-close-btn">&times;</button>
            <h2 id="learn-modal-title" class="text-xl font-bold mb-3"></h2>
            <div id="learn-modal-text" class="text-base"></div>
        </div>
    </div>
    <div id="theory-modal" class="modal">
        <div class="modal-content">
            <button id="theory-modal-close" class="modal-close-btn">&times;</button>
            <h2 class="text-2xl font-bold mb-4">תיאוריה וערכים אופייניים</h2>
            <p class="mb-4">תסבולת כלונס בודד מורכבת מתרומת החיכוך לאורך דופן הכלונס ותרומת תסבולת הקצה בבסיסו, בניכוי משקלו העצמי של הכלונס.</p>
            <h3 class="text-xl font-semibold mt-4 mb-2">נוסחת החישוב הכללית:</h3>
            <div class="formula-box">
                <code class="formula">F<sub>ser</sub> = ( &Sigma; P &middot; l<sub>i</sub> &middot; &tau;<sub>i,all</sub> ) + ( A<sub>tip</sub> &middot; &sigma;<sub>tip,all</sub> ) - W<sub>pile</sub></code>
            </div>
            <h3 class="text-xl font-semibold mt-6 mb-2">ערכים אופייניים למאמצי חיכוך (&tau;<sub>all</sub>)</h3>
            <p class="text-sm text-gray-500 mb-2">הערכים הם המלצה בלבד ויש לבססם על נתוני יועץ קרקע. הערכים בטבלה הם ביחידות kPa.</p>
            <table id="theory-table-values" class="theory-table">
                <thead>
                    <tr><th>סיווג קרקע (USCS)</th><th>תיאור</th><th>מאמץ חיכוך מותר (&tau;<sub>all</sub>) [kPa]</th></tr>
                </thead>
                <tbody>
                    <!-- Populated by JS -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Hidden container for PDF export -->
    <div id="pdf-export-content" class="hidden"></div>

<script type="module">
    // --- 3D SCENE SETUP ---
    let scene, camera, renderer, controls, labelRenderer;
    let pileGroup = new THREE.Group();
    let annotationsGroup = new THREE.Group();
    const canvasContainer = document.getElementById('canvas-3d-container');

    function init3D() {
        // Scene
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0xf0f0f0);
        
        // Camera
        camera = new THREE.PerspectiveCamera(50, canvasContainer.clientWidth / canvasContainer.clientHeight, 0.1, 1000);
        camera.position.set(15, 5, 15);
        
        // Renderer
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        canvasContainer.appendChild(renderer.domElement);

        // Label Renderer
        labelRenderer = new THREE.CSS2DRenderer();
        labelRenderer.setSize( canvasContainer.clientWidth, canvasContainer.clientHeight );
        labelRenderer.domElement.style.position = 'absolute';
        labelRenderer.domElement.style.top = '0px';
        labelRenderer.domElement.style.pointerEvents = 'none'; // Make it transparent to mouse events
        canvasContainer.appendChild( labelRenderer.domElement );

        // Controls
        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;

        // Lighting
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(20, 30, 10);
        scene.add(directionalLight);
        const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.4);
        directionalLight2.position.set(-20, 30, -10);
        scene.add(directionalLight2);

        // Ground Grid
        const gridHelper = new THREE.GridHelper( 60, 60 );
        scene.add( gridHelper );
        
        scene.add(pileGroup);
        scene.add(annotationsGroup);

        animate();
        
        window.addEventListener('resize', onWindowResize, false);
    }

    function onWindowResize() {
        camera.aspect = canvasContainer.clientWidth / canvasContainer.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
        labelRenderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
    }

    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
        labelRenderer.render(scene, camera);
    }

    function update3DScene(result) {
        const { params } = result;
        // Clear previous objects
        while(pileGroup.children.length > 0){ pileGroup.remove(pileGroup.children[0]); }
        while(annotationsGroup.children.length > 0){ annotationsGroup.remove(annotationsGroup.children[0]); }
        
        const pileRadius = params.pile_diameter_m / 2;
        let totalDepth = 0;
        params.layers.forEach(layer => { totalDepth += layer.thickness; });
        
        if (totalDepth <= 0) return;

        // Create Pile
        const pileMaterial = new THREE.MeshStandardMaterial({ color: 0x9e9e9e, metalness: 0.2, roughness: 0.6 });
        const pileGeometry = new THREE.CylinderGeometry(pileRadius, pileRadius, totalDepth, 32);
        const pile = new THREE.Mesh(pileGeometry, pileMaterial);
        pile.position.y = -totalDepth / 2;
        pileGroup.add(pile);

        // Create Soil Layers
        let currentDepth = 0;
        const soilColors = [0x8B4513, 0xD2B48C, 0xA0522D, 0xCD853F, 0xF4A460, 0xDEB887];
        const soilLayerRadius = Math.max(5, pileRadius * 8);
        const maxFriction = Math.max(...params.layers.map(l => l.friction_stress), 1);

        params.layers.forEach((layer, index) => {
            const layerHeight = layer.thickness;
            const layerGeometry = new THREE.CylinderGeometry(soilLayerRadius, soilLayerRadius, layerHeight, 48, 1, true);
            const layerMaterial = new THREE.MeshStandardMaterial({ 
                color: soilColors[index % soilColors.length],
                transparent: true,
                opacity: 0.25,
                side: THREE.DoubleSide
            });
            const soilLayer = new THREE.Mesh(layerGeometry, layerMaterial);
            soilLayer.position.y = -(currentDepth + layerHeight / 2);
            pileGroup.add(soilLayer);

            // Add Layer Info Label
            const pressureUnit = currentUnitSystem === 'kpa' ? 'kPa' : 't/m²';
            const fromKpa = (val) => currentUnitSystem === 'ton' ? val / KPA_PER_TON : val;
            const labelDiv = document.createElement('div');
            labelDiv.className = 'label';
            labelDiv.innerHTML = `
                <div class="label-title">${layer.uscs || `שכבה ${index + 1}`}</div>
                <div>l = ${layer.thickness.toFixed(1)} מ'</div>
                <div>&tau; = ${fromKpa(layer.friction_stress).toFixed(1)} ${pressureUnit}</div>
            `;
            const infoLabel = new THREE.CSS2DObject(labelDiv);
            infoLabel.position.set(soilLayerRadius, -(currentDepth + layerHeight / 2), 0);
            annotationsGroup.add(infoLabel);

            // Add Friction Arrows for this layer
            const frictionZoneStart = Math.max(currentDepth, params.friction_ignore_depth);
            const frictionZoneEnd = currentDepth + layerHeight;
            if (frictionZoneEnd > frictionZoneStart && layer.friction_stress > 0) {
                const frictionDensity = layer.friction_stress / maxFriction;
                const numFrictionArrows = Math.floor(2 + 10 * frictionDensity);
                const arrowLength = 1.5;
                for (let i = 0; i < numFrictionArrows; i++) {
                    const angle = (i / numFrictionArrows) * Math.PI * 2;
                    const x = (pileRadius + 0.1) * Math.cos(angle);
                    const z = (pileRadius + 0.1) * Math.sin(angle);
                    const yPos = -(frictionZoneStart + (Math.random() * (frictionZoneEnd - frictionZoneStart)));
                    
                    const frictionArrow = new THREE.ArrowHelper(new THREE.Vector3(0, 1, 0), new THREE.Vector3(x, yPos, z), arrowLength, 0x16a34a, 0.2, 0.2);
                    annotationsGroup.add(frictionArrow);
                }
            }
            
            currentDepth += layerHeight;
        });

        // Add Force Arrows & Dimensions
        // Load P
        const loadArrow = new THREE.ArrowHelper(new THREE.Vector3(0, -1, 0), new THREE.Vector3(0, 2, 0), 2, 0xdc2626, 0.5, 0.5);
        annotationsGroup.add(loadArrow);
        addTextLabel("P", 0, 2.5, 0, "text-red-600 font-bold");

        // Tip Resistance
        for(let i = 0; i < 5; i++) {
            const angle = (i / 5) * Math.PI * 2;
            const x = (pileRadius * 0.6) * Math.cos(angle);
            const z = (pileRadius * 0.6) * Math.sin(angle);
            const tipArrow = new THREE.ArrowHelper(new THREE.Vector3(0, 1, 0), new THREE.Vector3(x, -totalDepth, z), 1.5, 0x2563eb, 0.3, 0.3);
            annotationsGroup.add(tipArrow);
        }
        addTextLabel("F_tip", 0, -totalDepth - 1.5, 0, "text-blue-600 font-bold");


        // Dimensions
        addDimensionLine(new THREE.Vector3(-soilLayerRadius, 0, 0), new THREE.Vector3(-soilLayerRadius, -totalDepth, 0), `L = ${totalDepth.toFixed(1)} m`);
        addDimensionLine(new THREE.Vector3(-pileRadius, 1, 0), new THREE.Vector3(pileRadius, 1, 0), `D = ${params.pile_diameter_m.toFixed(2)} m`);


        // Adjust camera to fit the scene
        const box = new THREE.Box3().setFromObject(pileGroup);
        const center = box.getCenter(new THREE.Vector3());
        const size = box.getSize(new THREE.Vector3());
        const maxDim = Math.max(size.x, size.y, size.z);
        
        camera.position.set(center.x + maxDim, center.y + maxDim/2, center.z + maxDim);
        
        if (controls) {
            controls.target.copy(center);
            controls.update();
        }
    }

    function addTextLabel(text, x, y, z, className = '') {
        const div = document.createElement('div');
        div.className = 'label ' + className;
        div.textContent = text;
        const label = new THREE.CSS2DObject(div);
        label.position.set(x, y, z);
        annotationsGroup.add(label);
    }
    
    function addDimensionLine(start, end, text) {
        const material = new THREE.LineBasicMaterial({ color: 0x333333 });
        const points = [start, end];
        const geometry = new THREE.BufferGeometry().setFromPoints(points);
        const line = new THREE.Line(geometry, material);
        annotationsGroup.add(line);

        // Ticks
        const tickSize = 0.2;
        const tick1Points = [start, start.clone().add(new THREE.Vector3(tickSize, 0, 0))];
        const tick2Points = [end, end.clone().add(new THREE.Vector3(tickSize, 0, 0))];
        const tick1 = new THREE.Line(new THREE.BufferGeometry().setFromPoints(tick1Points), material);
        const tick2 = new THREE.Line(new THREE.BufferGeometry().setFromPoints(tick2Points), material);
        annotationsGroup.add(tick1, tick2);

        // Label
        const labelDiv = document.createElement('div');
        labelDiv.className = 'label';
        labelDiv.textContent = text;
        const label = new THREE.CSS2DObject(labelDiv);
        const midPoint = start.clone().add(end).multiplyScalar(0.5);
        label.position.copy(midPoint).add(new THREE.Vector3(-1, 0, 0));
        annotationsGroup.add(label);
    }


    // --- DOM ELEMENT SELECTION ---
    const themeToggleButton = document.getElementById('theme-toggle-btn');
    const themeIconSun = document.getElementById('theme-icon-sun');
    const themeIconMoon = document.getElementById('theme-icon-moon');
    const learnModeCheckbox = document.getElementById('learn-mode-checkbox');
    const unitToggleButton = document.getElementById('unit-toggle');
    const theoryBtn = document.getElementById('theory-btn');
    const exportPdfBtn = document.getElementById('export-pdf-btn');
    const mainBody = document.querySelector('body');
    const tabs = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    const calculateButton = document.getElementById('calculateButton');
    const addLayerBtn = document.getElementById('add-layer-btn');
    const layersContainer = document.getElementById('soil-layers-container');
    const resultsBox = document.getElementById('resultsBox');
    const summaryBoxContainer = document.getElementById('summary-box-container');
    const fSerOutput = document.getElementById('f_ser_output');
    const frictionContribOutput = document.getElementById('friction_contrib_output');
    const tipContribOutput = document.getElementById('tip_contrib_output');
    const weightContribOutput = document.getElementById('weight_contrib_output');
    const solutionContainer = document.getElementById('solution-steps-container');
    const imageModal = document.getElementById('image-modal');
    const modalImage = document.getElementById('modal-image');
    const imageModalCloseBtn = imageModal.querySelector('.modal-close-btn');
    const learnModal = document.getElementById('learn-modal');
    const learnModalClose = document.getElementById('learn-modal-close');
    const learnModalTitle = document.getElementById('learn-modal-title');
    const learnModalText = document.getElementById('learn-modal-text');
    const theoryModal = document.getElementById('theory-modal');
    const theoryModalClose = document.getElementById('theory-modal-close');
    const alertModal = document.getElementById('alert-modal');
    const alertModalText = document.getElementById('alert-modal-text');
    const alertModalClose = document.getElementById('alert-modal-close');
    const calculateCostBtn = document.getElementById('calculateCostBtn');


    let layerCounter = 0;
    let lastCalculationResult = {};
    let currentUnitSystem = 'kpa'; // 'kpa' or 'ton'
    const KPA_PER_TON = 10;
    let frictionChart, capacityChart;

    // --- DATA LIBRARIES ---
    const soilLibrary = {
        'CH': { name: 'חרסית שמנה', friction: 25 },
        'CL': { name: 'חרסית דלה', friction: 40 },
        'SW': { name: 'חול נקי', friction: 50 },
        'SP': { name: 'חול דק', friction: 45 },
        'SM': { name: 'חול טיני', friction: 35 },
        'SC': { name: 'חול חרסיתי', friction: 30 },
        'GW': { name: 'חצץ נקי', friction: 60 },
        'GP': { name: 'חצץ דק', friction: 55 },
        'GW-GC': { name: 'חצץ עם חרסית', friction: 58 },
        'GW-GM': { name: 'חצץ עם טין', friction: 55 },
        'GP-GC': { name: 'חצץ דל עם חרסית', friction: 52 },
        'GP-GM': { name: 'חצץ דל עם טין', friction: 50 },
        'SW-SC': { name: 'חול עם חרסית', friction: 48 },
        'SP-SC': { name: 'חול דל עם חרסית', friction: 42 },
        'SP-SM': { name: 'חול דל עם טין', friction: 38 },
        'SC-SM': { name: 'חול חרסיתי-טיני', friction: 32 },
        'Rock': { name: 'סלע', friction: 80 },
        'Air': { name: 'אוויר / חלל קארסטי', friction: 0 },
    };

    const learnContent = {
        pile_diameter: { title: 'קוטר כלונס (D)', text: '<p>הקוטר החיצוני של הכלונס. משפיע ישירות על היקף הכלונס (לחישוב החיכוך) ועל שטח החתך בקצה (לחישוב תסבולת הקצה ומשקל עצמי).</p>' },
        friction_ignore_depth: { title: 'התעלמות מחיכוך עליון', text: '<h3>מדוע מתעלמים מחיכוך בחלק העליון של הכלונס?</h3><p>בפרקטיקה ההנדסית, נהוג להתעלם מתרומת החיכוך בחלקו העליון של הכלונס (בדרך כלל 1-2 מטרים ראשונים). הסיבות לכך הן:</p><ul class="list-disc pr-5 mt-2"><li><b>הפרעות בקרקע:</b> השכבות העליונות של הקרקע חשופות להפרעות בנייה, חפירות עתידיות, והתקנת תשתיות. הפרעות אלו עלולות לפגוע במגע בין הכלונס לקרקע ולהפחית את החיכוך בפועל.</li><li><b>שינויי לחות ונפח:</b> הקרקע העליונה מושפעת משינויי מזג אוויר (גשם, יובש), הגורמים לשינויי לחות המובילים לתפיחה והתכווצות של הקרקע. תנודות אלו עלולות ליצור מרווח בין הכלונס לקרקע ("gapping") ולבטל את החיכוך.</li><li><b>שחיקה (Scour):</b> באזורים עם זרימת מים (כמו ליד נהרות או בים), השכבה העליונה עלולה להיסחף, מה שחושף את ראש הכלונס ומבטל את החיכוך באותו אזור.</li></ul><p>ההתעלמות מהחיכוך העליון מהווה מקדם ביטחון נוסף בתכנון, המבטיח שהתסבולת המחושבת תהיה בצד הבטוח.</p>' },
        concrete_density: { title: 'משקל מרחבי של בטון (γ<sub>c</sub>)', text: '<p>משקל הבטון ליחידת נפח. משמש לחישוב המשקל העצמי של הכלונס, אותו יש להפחית מהתסבולת הכוללת. ערך מקובל לבטון מזוין הוא כ-25 kN/m³ או 2.5 t/m³.</p>' },
        layer_thickness: { title: 'עובי שכבה (l<sub>i</sub>)', text: '<p>העובי האנכי של שכבת קרקע ספציפית. סכום עובי השכבות קובע את עומק הכלונס.</p>' },
        layer_friction: { title: 'מאמץ חיכוך מותר (τ<sub>i,all</sub>)', text: '<p>מאמץ הגזירה המותר בין דופן הכלונס לבין הקרקע בשכבה זו. זהו ערך התלוי בסוג הקרקע, צפיפותה, ושיטת ביצוע הכלונס. הוא מייצג את "האחיזה" של הקרקע בכלונס.</p>' },
        layer_tip_bearing: { title: 'מאמץ מגע מותר בקצה (σ<sub>tip,all</sub>)', text: '<p>המאמץ האנכי המותר שהקרקע בשכבת הקצה יכולה לשאת. ערך זה רלוונטי רק לשכבה שבה מסתיים הכלונס, והוא תלוי בחוזק הקרקע ובסוגה (סלע, חול צפוף וכו\').</p>' },
        tip_layer: { title: 'שכבת קצה', text: '<p>זוהי השכבה שבה בסיס הכלונס ממוקם. יש לסמן את השכבה הרלוונטית כדי שהמחשבון יידע היכן לחשב את תסבולת הקצה, ועד איזה עומק לחשב את החיכוך.</p>' },
        friction_graph_explanation: { title: 'גרף התפתחות החיכוך', text: '<p>גרף זה מציג את ערך **מאמץ החיכוך המותר ($$\\tau$$)** בכל עומק לאורך הכלונס.</p><ul class="list-disc pr-5 mt-2"><li>**ציר Y (אנכי):** מייצג את העומק במטרים.</li><li>**ציר X (אופקי):** מייצג את מאמץ החיכוך ביחידות שנבחרו.</li><li>**מדרגות:** כל "מדרגה" בגרף מייצגת שכבת קרקע. גובה המדרגה מראה את ערך החיכוך באותה שכבה. ניתן לראות בבירור כיצד המאמץ משתנה (או נשאר קבוע) בין השכבות השונות.</li><li>**אזור אפס:** בתחילת הגרף, באזור ההתעלמות מחיכוך, הערך הוא אפס.</li></ul><p>הגרף עוזר להבין אילו שכבות תורמות הכי הרבה לתסבולת החיכוך של הכלונס.</p>' },
        capacity_graph_explanation: { title: 'גרף תסבולת מצטברת', text: '<p>גרף זה ממחיש כיצד **התסבולת הכוללת של הכלונס נבנית** ככל שהוא חודר עמוק יותר לקרקע.</p><ul class="list-disc pr-5 mt-2"><li>**ציר Y (אנכי):** מייצג את העומק במטרים.</li><li>**ציר X (אופקי):** מייצג את כוח התסבולת המצטבר ביחידות שנבחרו (kN או טון).</li><li>**שיפוע הגרף:** השיפוע מייצג את קצב צבירת התסבולת. שיפוע תלול יותר פירושו שתסבולת החיכוך באותה שכבה גבוהה יותר.</li><li>**קפיצה בסוף:** הקפיצה הגדולה בסוף הגרף מייצגת את **תרומת תסבולת הקצה ($$F_{tip}$$)**, המתווספת בבת אחת בבסיס הכלונס.</li></ul><p>הגרף מספק תמונה אינטואיטיבית של "ביצועי" הכלונס בעומקים השונים.</p>' }
    };

    // --- INITIALIZATION ---
    function init() {
        init3D();
        applyTheme(localStorage.getItem('theme') || 'light');
        applyUnitSystem(localStorage.getItem('unitSystem') || 'kpa', false);
        populateTheoryModal();
        
        addLayer(); // Add first layer
        addLayer(); // Add second layer
        
        const firstLayer = layersContainer.querySelector('.soil-layer:nth-child(1)');
        if(firstLayer) {
            firstLayer.querySelector('.uscs-select').value = 'CH';
            firstLayer.querySelector('[data-type="friction"]').value = 25;
        }

        const secondLayer = layersContainer.querySelector('.soil-layer:nth-child(2)');
        if (secondLayer) {
            secondLayer.querySelector('.uscs-select').value = 'SW';
            secondLayer.querySelector('[data-type="thickness"]').value = 4;
            secondLayer.querySelector('[data-type="friction"]').value = 50;
            secondLayer.querySelector('[data-type="tip_bearing"]').value = 400;
        }
        
        setupEventListeners();
        triggerCalculation();
        embedGuide();
    }

    // --- EVENT LISTENERS ---
    function setupEventListeners() {
        themeToggleButton.addEventListener('click', () => {
            const newTheme = document.documentElement.classList.toggle('dark') ? 'dark' : 'light';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });

        learnModeCheckbox.addEventListener('change', () => {
            mainBody.classList.toggle('learn-mode-active', learnModeCheckbox.checked);
        });

        unitToggleButton.addEventListener('click', () => {
            const newSystem = currentUnitSystem === 'kpa' ? 'ton' : 'kpa';
            applyUnitSystem(newSystem, true);
        });

        theoryBtn.addEventListener('click', () => theoryModal.classList.add('visible'));
        theoryModalClose.addEventListener('click', () => theoryModal.classList.remove('visible'));
        exportPdfBtn.addEventListener('click', exportToPdf);

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const target = tab.dataset.tab;
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                tabContents.forEach(content => content.classList.toggle('active', content.id === target));
            });
        });

        addLayerBtn.addEventListener('click', addLayer);
        calculateButton.addEventListener('click', triggerCalculation);
        calculateCostBtn.addEventListener('click', calculateCosts);
        
        document.getElementById('pile_diameter').addEventListener('input', triggerCalculation);
        
        layersContainer.addEventListener('input', (e) => {
            if (e.target.matches('input, select')) {
                if (e.target.type === 'radio' && e.target.name === 'tip-layer-radio') {
                    if (learnModeCheckbox.checked) {
                        e.preventDefault();
                        showLearnModal('tip_layer');
                        e.target.checked = !e.target.checked; // Revert the change
                        return;
                    }
                    updateTipBearingInputs();
                }
                if (e.target.classList.contains('uscs-select')) {
                    handleUscsSelection(e.target);
                }
                triggerCalculation();
            }
        });
        
        layersContainer.addEventListener('click', (e) => {
            if (e.target.closest('.remove-layer-btn')) {
                removeLayer(e.target.closest('.remove-layer-btn'));
            }
             if (learnModeCheckbox.checked && e.target.closest('.layer-radio-label')) {
                e.preventDefault();
                showLearnModal('tip_layer');
            }
        });

        imageModalCloseBtn.addEventListener('click', () => imageModal.classList.remove('visible'));
        imageModal.addEventListener('click', (e) => { if (e.target === imageModal) imageModal.classList.remove('visible'); });
        
        learnModalClose.addEventListener('click', () => learnModal.classList.remove('visible'));
        learnModal.addEventListener('click', (e) => { if (e.target === learnModal) learnModal.classList.remove('visible'); });
        alertModalClose.addEventListener('click', () => alertModal.classList.remove('visible'));
        alertModal.addEventListener('click', (e) => { if (e.target === alertModal) alertModal.classList.remove('visible'); });

        mainBody.addEventListener('click', (e) => {
            const target = e.target.closest('[data-learn-key]');
            if (learnModeCheckbox.checked && target) {
                 if (target.classList.contains('layer-radio-label')) return;
                e.preventDefault();
                showLearnModal(target.dataset.learnKey);
            }
        });
        
        solutionContainer.addEventListener('click', (e) => {
            const target = e.target.closest('.formula-variable');
             if (target && target.dataset.learnKey) {
                e.preventDefault();
                showLearnModal(target.dataset.learnKey);
            }
        });
    }
    
    // --- UI & THEME & MODALS LOGIC ---
    function applyTheme(theme) {
        if (theme === 'dark') {
            document.documentElement.classList.add('dark');
            themeIconSun.classList.add('hidden');
            themeIconMoon.classList.remove('hidden');
            if (scene) scene.background = new THREE.Color(0x1f2937);
        } else {
            document.documentElement.classList.remove('dark');
            themeIconSun.classList.remove('hidden');
            themeIconMoon.classList.add('hidden');
            if (scene) scene.background = new THREE.Color(0xf0f0f0);
        }
        updateGraphs(lastCalculationResult);
    }

    function applyUnitSystem(system, convertValues) {
        const oldSystem = currentUnitSystem;
        currentUnitSystem = system;
        unitToggleButton.classList.toggle('kpa-active', system === 'kpa');
        unitToggleButton.classList.toggle('ton-active', system === 'ton');
        
        const pressureUnit = system === 'kpa' ? 'kPa' : 't/m²';
        const densityUnit = system === 'kpa' ? 'kN/m³' : 't/m³';
        
        document.getElementById('gamma_c_unit_label').textContent = densityUnit;
        document.querySelectorAll('.friction-unit-label').forEach(l => l.textContent = `[${pressureUnit}]`);
        document.querySelectorAll('.tip-unit-label').forEach(l => l.textContent = `[${pressureUnit}]`);

        if (convertValues && oldSystem !== system) {
            const factor = system === 'ton' ? 1 / KPA_PER_TON : KPA_PER_TON;
            const fieldsToConvert = document.querySelectorAll('[data-type="friction"], [data-type="tip_bearing"], #concrete_density');
            fieldsToConvert.forEach(input => {
                const val = parseFloat(input.value);
                if (!isNaN(val)) {
                    input.value = (val * factor).toFixed(2);
                }
            });
        }
        
        localStorage.setItem('unitSystem', system);
        if (Object.keys(lastCalculationResult).length > 0) {
            triggerCalculation(); // Recalculate and redraw everything
        }
    }
    
    function showAlert(message) {
        alertModalText.textContent = message;
        alertModal.classList.add('visible');
    }

    function openImageInModal(canvasElement) {
        const dataUrl = canvasElement.toDataURL('image/png', 1.0);
        modalImage.src = dataUrl;
        imageModal.classList.add('visible');
    }

    function showLearnModal(key) {
        if (!learnContent[key]) return;
        const content = learnContent[key];
        learnModalTitle.innerHTML = content.title;
        learnModalText.innerHTML = content.text;
        learnModal.classList.add('visible');
    }

    function populateTheoryModal() {
        const tableBody = document.getElementById('theory-table-values').querySelector('tbody');
        tableBody.innerHTML = '';
        for (const key in soilLibrary) {
            const soil = soilLibrary[key];
            const row = `<tr><td>${key}</td><td>${soil.name}</td><td>${soil.friction}</td></tr>`;
            tableBody.innerHTML += row;
        }
    }

    // --- LAYER MANAGEMENT ---
    function addLayer() {
        layerCounter++;
        const layerId = `layer-${layerCounter}`;
        const pressureUnit = currentUnitSystem === 'kpa' ? 'kPa' : 't/m²';

        let uscsOptions = '<option value="">-- בחר סוג --</option>';
        for (const key in soilLibrary) {
            uscsOptions += `<option value="${key}">${key} - ${soilLibrary[key].name}</option>`;
        }

        const layerHtml = `
            <div class="soil-layer" id="${layerId}">
                <div class="layer-header">
                    <span>שכבה ${layerCounter}</span>
                    <label class="layer-radio-label" data-learn-key="tip_layer">
                        <input type="radio" name="tip-layer-radio" value="${layerId}">
                        <span class="mr-2">שכבת קצה</span>
                    </label>
                    <button class="remove-layer-btn btn-danger rounded-full !p-1 h-7 w-7" aria-label="Remove layer ${layerCounter}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-4 mt-2">
                    <div>
                        <label for="${layerId}-thickness" class="input-label !text-sm" data-learn-key="layer_thickness">עובי שכבה (l) [מ']</label>
                        <input type="number" id="${layerId}-thickness" data-type="thickness" value="4.0" class="input-field">
                    </div>
                    <div>
                        <label for="${layerId}-uscs" class="input-label !text-sm">סוג קרקע (USCS)</label>
                        <select id="${layerId}-uscs" data-type="uscs" class="uscs-select select-field">${uscsOptions}</select>
                    </div>
                    <div class="sm:col-span-2">
                        <label for="${layerId}-friction" class="input-label !text-sm" data-learn-key="layer_friction">מאמץ חיכוך מותר (τ) <span class="friction-unit-label">[${pressureUnit}]</span></label>
                        <input type="number" id="${layerId}-friction" data-type="friction" value="25" class="input-field">
                    </div>
                    <div class="sm:col-span-2">
                        <label for="${layerId}-tip_bearing" class="input-label !text-sm" data-learn-key="layer_tip_bearing">מאמץ מגע מותר בקצה (σ<sub>tip</sub>) <span class="tip-unit-label">[${pressureUnit}]</span></label>
                        <input type="number" id="${layerId}-tip_bearing" data-type="tip_bearing" value="0" class="input-field">
                    </div>
                </div>
            </div>
        `;
        layersContainer.insertAdjacentHTML('beforeend', layerHtml);
        if (layersContainer.children.length === 1) {
            layersContainer.querySelector('input[type="radio"]').checked = true;
        }
        updateLayerNumbers();
        updateTipBearingInputs();
        triggerCalculation();
    }

    function handleUscsSelection(selectElement) {
        const selectedValue = selectElement.value;
        if (!selectedValue) return;

        const soilData = soilLibrary[selectedValue];
        if (!soilData) return;

        const layerDiv = selectElement.closest('.soil-layer');
        if (!layerDiv) return; // Guard clause
        const frictionInput = layerDiv.querySelector('[data-type="friction"]');
        
        let frictionValue = soilData.friction;
        if (currentUnitSystem === 'ton') {
            frictionValue /= KPA_PER_TON;
        }

        frictionInput.value = frictionValue.toFixed(2);
        
        if (selectedValue === 'Air') {
            const tipInput = layerDiv.querySelector('[data-type="tip_bearing"]');
            frictionInput.value = 0;
            tipInput.value = 0;
            frictionInput.disabled = true;
            tipInput.disabled = true;
        } else {
            frictionInput.disabled = false;
            updateTipBearingInputs(); // Re-evaluate if tip input should be disabled
        }
    }

    function removeLayer(button) {
        if (layersContainer.children.length <= 1) {
            showAlert("חייבת להיות לפחות שכבת קרקע אחת.");
            return;
        }
        const layerToRemove = button.closest('.soil-layer');
        const wasChecked = layerToRemove.querySelector('input[type="radio"]').checked;
        layerToRemove.remove();
        
        if (wasChecked && layersContainer.children.length > 0) {
            layersContainer.querySelector('.soil-layer:last-child input[type="radio"]').checked = true;
        }
        
        updateLayerNumbers();
        updateTipBearingInputs();
        triggerCalculation();
    }

    function updateLayerNumbers() {
        const layers = layersContainer.querySelectorAll('.soil-layer');
        layers.forEach((layer, index) => {
            layer.querySelector('.layer-header span').textContent = `שכבה ${index + 1}`;
            layer.querySelector('.remove-layer-btn').disabled = layers.length <= 1;
        });
    }

    function updateTipBearingInputs() {
        const layers = layersContainer.querySelectorAll('.soil-layer');
        layers.forEach(layer => {
            const isTipLayer = layer.querySelector('input[type="radio"]').checked;
            const tipInput = layer.querySelector('[data-type="tip_bearing"]');
            const uscsValue = layer.querySelector('.uscs-select').value;
            
            if (uscsValue === 'Air') {
                 tipInput.disabled = true;
            } else {
                tipInput.disabled = !isTipLayer;
                tipInput.parentElement.style.opacity = isTipLayer ? '1' : '0.5';
            }
            if (!isTipLayer) {
                tipInput.value = 0;
            }
        });
    }

    // --- DATA GATHERING & VALIDATION ---
    function validateInputs(inputs) {
        const pileDiameter = inputs.pile_diameter_m * 100;
        if (isNaN(pileDiameter) || pileDiameter < 20 || pileDiameter > 300) {
            showAlert("קוטר הכלונס חייב להיות בין 20 ל-300 ס\"מ.");
            return false;
        }

        const concreteDensity = inputs.concrete_density;
        if (isNaN(concreteDensity) || concreteDensity < 20 || concreteDensity > 28) {
            showAlert("המשקל המרחבי של הבטון חייב להיות בין 20 ל-28 kN/m³.");
            return false;
        }

        const totalLength = inputs.layers.reduce((sum, l) => sum + (l.thickness || 0), 0);
        if (isNaN(inputs.friction_ignore_depth) || inputs.friction_ignore_depth < 0 || inputs.friction_ignore_depth > totalLength) {
            showAlert(`עומק התעלמות מחיכוך חייב להיות בין 0 לאורך הכלונס (${totalLength.toFixed(1)} מ').`);
            return false;
        }

        for (let i = 0; i < inputs.layers.length; i++) {
            const layer = inputs.layers[i];
            if (isNaN(layer.thickness) || layer.thickness <= 0) {
                showAlert(`עובי שכבה ${i+1} חייב להיות ערך חיובי.`);
                return false;
            }
            if (isNaN(layer.friction_stress) || layer.friction_stress < 0 || isNaN(layer.tip_bearing_stress) || layer.tip_bearing_stress < 0) {
                showAlert(`המאמצים בשכבה ${i+1} לא יכולים להיות שליליים.`);
                return false;
            }
        }
        if (!inputs.layers.some(l => l.is_tip_layer)) {
            showAlert("יש לסמן שכבת קצה אחת.");
            return false;
        }
        return true;
    }

    function getInputs() {
        const pile_diameter_cm = parseFloat(document.getElementById('pile_diameter').value);
        const toKpa = (val) => currentUnitSystem === 'ton' ? val * KPA_PER_TON : val;

        const inputs = {
            pile_diameter_m: pile_diameter_cm / 100,
            friction_ignore_depth: parseFloat(document.getElementById('friction_ignore_depth').value),
            concrete_density: toKpa(parseFloat(document.getElementById('concrete_density').value)),
            layers: []
        };

        const layerElements = layersContainer.querySelectorAll('.soil-layer');
        let tipLayerFound = false;
        
        for (const layerEl of layerElements) {
            if (tipLayerFound) continue;

            const isTipLayer = layerEl.querySelector('input[type="radio"]').checked;
            const layerData = {
                id: layerEl.id,
                thickness: parseFloat(layerEl.querySelector('[data-type="thickness"]').value),
                friction_stress: toKpa(parseFloat(layerEl.querySelector('[data-type="friction"]').value)),
                tip_bearing_stress: isTipLayer ? toKpa(parseFloat(layerEl.querySelector('[data-type="tip_bearing"]').value)) : 0,
                is_tip_layer: isTipLayer,
                uscs: layerEl.querySelector('[data-type="uscs"]').value
            };
            inputs.layers.push(layerData);

            if (isTipLayer) {
                tipLayerFound = true;
            }
        }
        return inputs;
    }

    // --- CALCULATION LOGIC ---
    function triggerCalculation() {
        const params = getInputs();
        if (!validateInputs(params)) {
            resultsBox.classList.add("hidden");
            summaryBoxContainer.innerHTML = "";
            return;
        }

        const D = params.pile_diameter_m;
        const perimeter = Math.PI * D;
        const tip_area = Math.PI * Math.pow(D / 2, 2);

        let total_friction_force = 0;
        let total_length = 0;
        let depth_so_far = 0;

        for (const layer of params.layers) {
            total_length += layer.thickness;
            const start_depth = depth_so_far;
            const end_depth = start_depth + layer.thickness;
            const effective_length = Math.max(0, end_depth - Math.max(start_depth, params.friction_ignore_depth));
            total_friction_force += perimeter * effective_length * layer.friction_stress;
            depth_so_far = end_depth;
        }

        const tip_bearing_force = tip_area * (params.layers.find(l => l.is_tip_layer)?.tip_bearing_stress || 0);
        const pile_weight = tip_area * total_length * params.concrete_density;
        const f_ser = total_friction_force + tip_bearing_force - pile_weight;

        lastCalculationResult = { f_ser, total_friction_force, tip_bearing_force, pile_weight, params };

        updateSummaryBox(params, total_length);
        animateResults(lastCalculationResult);
        resultsBox.classList.remove("hidden");
        update3DScene(lastCalculationResult);
        updateGraphs(lastCalculationResult);
        populateSolutionTab(lastCalculationResult); // Bug fix: ensure this is always called
    }

    function updateSummaryBox(params, total_length) {
        const html = `
            <div class="summary-box">
                <h3 class="section-title !text-lg !border-indigo-400 !mb-3">סיכום נתונים</h3>
                <p><span class="summary-label">קוטר כלונס:</span> <span class="summary-value">${params.pile_diameter_m * 100} ס"מ</span></p>
                <p><span class="summary-label">אורך כלונס כולל:</span> <span class="summary-value">${total_length.toFixed(2)} מ'</span></p>
            </div>
        `;
        summaryBoxContainer.innerHTML = html;
    }

    function animateResults(data) {
        document.querySelectorAll('.result-value').forEach(el => el.classList.remove('visible'));
        
        const fromKpa = (val) => currentUnitSystem === 'ton' ? val / KPA_PER_TON : val;
        const loadUnit = currentUnitSystem === 'kpa' ? 'kN' : 't';

        setTimeout(() => {
            fSerOutput.textContent = isNaN(data.f_ser) ? "-" : `${fromKpa(data.f_ser).toFixed(2)} ${loadUnit}`;
            frictionContribOutput.textContent = `תרומת חיכוך: ${fromKpa(data.total_friction_force).toFixed(2)} ${loadUnit}`;
            tipContribOutput.textContent = `תרומת קצה: ${fromKpa(data.tip_bearing_force).toFixed(2)} ${loadUnit}`;
            weightContribOutput.textContent = `הפחתת משקל עצמי: ${fromKpa(data.pile_weight).toFixed(2)} ${loadUnit}`;

            setTimeout(() => {
                document.querySelectorAll('.result-value').forEach(el => el.classList.add('visible'));
            }, 50);
        }, 10);
    }
    
    // --- SOLUTION TAB LOGIC ---
    function populateSolutionTab(data) {
        if (!data || !data.params || isNaN(data.f_ser)) {
            solutionContainer.innerHTML = `<div class="text-center p-8 text-gray-500"><p>בצע חישוב בלשונית "חישוב הנדסי" כדי להציג את מהלך הפתרון המפורט.</p></div>`;
            return;
        }
        
        const { params } = data;
        const D = params.pile_diameter_m;
        const perimeter = Math.PI * D;
        const tip_area = Math.PI * Math.pow(D / 2, 2);
        const fromKpa = (val) => currentUnitSystem === 'ton' ? val / KPA_PER_TON : val;
        const fromKpaDensity = (val) => currentUnitSystem === 'ton' ? val / KPA_PER_TON : val;
        const loadUnit = currentUnitSystem === 'kpa' ? 'kN' : 't';
        const densityUnit = currentUnitSystem === 'kpa' ? 'kN/m³' : 't/m³';

        const generateLegend = (vars) => {
            const varMap = { 
                F_ser: 'התסבולת המותרת בשירות', 
                Perimeter: 'היקף הכלונס (P)', 
                l_i: 'אורך הכלונס בשכבה i', 
                'τ_i_all': 'מאמץ החיכוך המותר בשכבה i', 
                A_tip: 'שטח חתך קצה הכלונס', 
                'σ_tip_all': 'מאמץ המגע המותר בקצה', 
                W_pile: 'המשקל העצמי של הכלונס' 
            };
            let html = `<details class="legend-details"><summary>מקרא אינטראקטיבי לנוסחה</summary><ul class="legend-content list-disc pr-5 space-y-1 mt-2">`;
            vars.forEach(v => {
                if (varMap[v]) {
                    let symbol = v.replace('_all', '<sub>,all</sub>').replace('_i', '<sub>i</sub>').replace('_tip', '<sub>tip</sub>');
                    html += `<li><span class="formula-variable" data-learn-key="${v.replace(/_i|_all/g, '')}">${symbol}</span>: ${varMap[v]}</li>`;
                }
            });
            html += `</ul></details>`;
            return html;
        };
        
        let html = ``;
        html += `<div class="solution-step"><h3 class="solution-step-title">שלב 1: נתוני הבעיה וחישובי בסיס</h3>
                    <p>בשלב זה נרכז את נתוני הבעיה ונחשב פרמטרים גיאומטריים בסיסיים של הכלונס שישמשו אותנו בהמשך.</p>
                    <p>קוטר כלונס: D = ${D * 100} ס"מ = ${D.toFixed(3)} מ'</p>
                    <p>התעלמות מחיכוך עליון: ${params.friction_ignore_depth} מ'</p>
                    <p>משקל מרחבי בטון: &gamma;<sub>c</sub> = ${fromKpaDensity(params.concrete_density).toFixed(2)} ${densityUnit}</p>
                    <div class="formula-box"><code class="formula">Perimeter = &pi; &middot; ${D.toFixed(3)} = ${perimeter.toFixed(3)} m</code></div>
                    <div class="formula-box"><code class="formula">A<sub>tip</sub> = &pi; &middot; (${D.toFixed(3)}/2)<sup>2</sup> = ${tip_area.toFixed(4)} m²</code></div>
                    ${generateLegend(['Perimeter', 'A_tip'])}
                    </div>`;
        
        html += `<div class="solution-step"><h3 class="solution-step-title">שלב 2: חישוב תרומת החיכוך (&Sigma; F<sub>friction</sub>)</h3>
                    <p>תרומת החיכוך היא סך הכוחות הנגרמים מהאחיזה של הקרקע בדפנות הכלונס. החישוב מתבצע עבור כל שכבה בנפרד, ונסכם.</p>`;
        
        let depth_so_far = 0;
        params.layers.forEach((layer, index) => {
            const start_depth = depth_so_far;
            const end_depth = start_depth + layer.thickness;
            const friction_start = Math.max(start_depth, params.friction_ignore_depth);
            const effective_length = Math.max(0, end_depth - friction_start);
            const layer_friction_force_kpa = perimeter * effective_length * layer.friction_stress;
            
            html += `<p class="mt-4"><b>שכבה ${index + 1} (${layer.uscs || 'N/A'}):</b></p>
                     <p>אורך אפקטיבי לחיכוך: l<sub>eff</sub> = max(0, ${end_depth.toFixed(2)} - ${friction_start.toFixed(2)}) = ${effective_length.toFixed(2)} מ'</p>
                     <div class="formula-box"><code class="formula">F<sub>fr,${index+1}</sub> = P &middot; l<sub>eff</sub> &middot; &tau;<sub>all</sub> = ${perimeter.toFixed(3)} &middot; ${effective_length.toFixed(2)} &middot; ${fromKpa(layer.friction_stress).toFixed(2)} = ${fromKpa(layer_friction_force_kpa).toFixed(2)} ${loadUnit}</code></div>`;
            depth_so_far = end_depth;
        });
        html += `<p class="mt-4 font-bold">סך תרומת החיכוך: <span class="highlighted-result">${fromKpa(data.total_friction_force).toFixed(2)} ${loadUnit}</span></p></div>`;

        html += `<div class="solution-step"><h3 class="solution-step-title">שלב 3: חישוב תרומת הקצה (F<sub>tip</sub>)</h3>
                    <p>תרומת הקצה היא הכוח שהקרקע בבסיס הכלונס יכולה לשאת. היא משמעותית במיוחד כאשר הכלונס נשען על שכבה חזקה או סלע.</p>
                    <div class="formula-box"><code class="formula">F<sub>tip</sub> = A<sub>tip</sub> &middot; &sigma;<sub>tip,all</sub> = ${tip_area.toFixed(4)} &middot; ${fromKpa(params.layers.find(l => l.is_tip_layer)?.tip_bearing_stress || 0).toFixed(2)} = <span class="highlighted-result">${fromKpa(data.tip_bearing_force).toFixed(2)} ${loadUnit}</span></code></div>
                    ${generateLegend(['A_tip', 'σ_tip_all'])}
                    </div>`;

        const total_length = params.layers.reduce((sum, l) => sum + l.thickness, 0);
        html += `<div class="solution-step"><h3 class="solution-step-title">שלב 4: חישוב משקל עצמי של הכלונס (W<sub>pile</sub>)</h3>
                    <p>יש להפחית את משקל הכלונס עצמו, מכיוון שהקרקע צריכה לתמוך בו בנוסף לעומס המבנה.</p>
                    <div class="formula-box"><code class="formula">W<sub>pile</sub> = A<sub>tip</sub> &middot; L &middot; &gamma;<sub>c</sub> = ${tip_area.toFixed(4)} &middot; ${total_length.toFixed(2)} &middot; ${fromKpaDensity(params.concrete_density).toFixed(2)} = <span class="highlighted-result">${fromKpa(data.pile_weight).toFixed(2)} ${loadUnit}</span></code></div>
                    ${generateLegend(['W_pile'])}
                    </div>`;
        
        html += `<div class="solution-step"><h3 class="solution-step-title">שלב 5: חישוב תסבולת מותרת סופית (F<sub>ser</sub>)</h3>
                    <p>התסבולת המותרת היא סך כל הכוחות שהקרקע מספקת (חיכוך וקצה), פחות המשקל העצמי שהקרקע צריכה לשאת.</p>
                    <div class="formula-box"><code class="formula">F<sub>ser</sub> = (&Sigma; F<sub>friction</sub>) + F<sub>tip</sub> - W<sub>pile</sub></code></div>
                    <div class="formula-box mt-4"><code class="formula">F<sub>ser</sub> = ${fromKpa(data.total_friction_force).toFixed(2)} + ${fromKpa(data.tip_bearing_force).toFixed(2)} - ${fromKpa(data.pile_weight).toFixed(2)}</code></div>
                    <p class="mt-4 text-xl font-bold text-center">F<sub>ser</sub> = <span class="highlighted-result text-xl">${fromKpa(data.f_ser).toFixed(2)} ${loadUnit}</span></p>
                    ${generateLegend(['F_ser', 'F_friction', 'F_tip', 'W_pile'])}
                    </div>`;

        solutionContainer.innerHTML = html;
    }

    // --- CHARTING LOGIC ---
    function updateGraphs(result) {
        if (!result || !result.params) return;

        if (frictionChart) frictionChart.destroy();
        if (capacityChart) capacityChart.destroy();

        drawFrictionGraph(result);
        drawCapacityGraph(result);
    }

    function getChartOptions(titleText, yAxisTitle, xAxisTitle) {
        const isDark = document.documentElement.classList.contains('dark');
        return {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index',
            },
            plugins: {
                title: { display: true, text: titleText, color: isDark ? '#E5E7EB' : '#1F2937', font: { size: 16, family: 'Assistant' } },
                legend: { labels: { color: isDark ? '#E5E7EB' : '#1F2937', font: { family: 'Assistant' } } },
                tooltip: {
                    enabled: true,
                    titleFont: { family: 'Assistant' },
                    bodyFont: { family: 'Assistant' },
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            label += `(עומק: ${context.parsed.y.toFixed(2)}, ערך: ${context.parsed.x.toFixed(2)})`;
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: { 
                    type: 'linear',
                    position: 'bottom',
                    title: { display: true, text: xAxisTitle, color: isDark ? '#9CA3AF' : '#4b5563', font: { family: 'Assistant' } },
                    ticks: { color: isDark ? '#9CA3AF' : '#4b5563', font: { family: 'Assistant' } },
                    grid: { color: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' },
                    beginAtZero: true
                },
                y: { 
                    type: 'linear',
                    position: 'left',
                    title: { display: true, text: yAxisTitle, color: isDark ? '#9CA3AF' : '#4b5563', font: { family: 'Assistant' } },
                    ticks: { color: isDark ? '#9CA3AF' : '#4b5563', font: { family: 'Assistant' } },
                    grid: { color: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' },
                    reverse: true
                }
            },
            parsing: {
              xAxisKey: 'x',
              yAxisKey: 'y'
            }
        };
    }

    function drawFrictionGraph(result) {
        const { params } = result;
        const pressureUnit = currentUnitSystem === 'kpa' ? 'kPa' : 't/m²';
        const fromKpa = (val) => currentUnitSystem === 'ton' ? val / KPA_PER_TON : val;
        
        const data = [];
        let currentDepth = 0;

        data.push({y: 0, x: 0});

        if (params.friction_ignore_depth > 0) {
            data.push({y: params.friction_ignore_depth, x: 0});
        }

        params.layers.forEach(layer => {
            const startDepth = currentDepth;
            const endDepth = currentDepth + layer.thickness;
            const frictionStartDepth = Math.max(startDepth, params.friction_ignore_depth);
            
            const currentFriction = fromKpa(layer.friction_stress);
            
            if (frictionStartDepth > startDepth && data[data.length - 1].y < frictionStartDepth) {
                 const prevFriction = data.length > 1 ? data[data.length - 2].x : 0;
                 data.push({y: startDepth, x: prevFriction});
                 data.push({y: frictionStartDepth, x: 0});
            }
            
            data.push({y: frictionStartDepth, x: currentFriction});
            data.push({y: endDepth, x: currentFriction});

            currentDepth = endDepth;
        });
        
        const ctx = document.getElementById('friction-graph').getContext('2d');
        frictionChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: `מאמץ חיכוך מותר (${pressureUnit})`,
                    data: data,
                    borderColor: '#16a34a',
                    backgroundColor: 'rgba(22, 163, 74, 0.2)',
                    stepped: true,
                    fill: false,
                    pointRadius: 0
                }]
            },
            options: getChartOptions('התפתחות החיכוך עם העומק', 'עומק (מ\')', `מאמץ (${pressureUnit})`)
        });
    }

    function drawCapacityGraph(result) {
        const { params, tip_bearing_force } = result;
        const loadUnit = currentUnitSystem === 'kpa' ? 'kN' : 't';
        const fromKpaForce = (val) => currentUnitSystem === 'ton' ? val / KPA_PER_TON : val;
        
        const data = [{y: 0, x: 0}];
        let currentDepth = 0;
        let cumulativeFriction = 0;
        const perimeter = Math.PI * params.pile_diameter_m;

        params.layers.forEach(layer => {
            const startDepth = currentDepth;
            const endDepth = currentDepth + layer.thickness;
            const frictionStartDepth = Math.max(startDepth, params.friction_ignore_depth);
            const effectiveLength = endDepth - frictionStartDepth;
            
            if (effectiveLength > 0) {
                const frictionInLayer = perimeter * effectiveLength * layer.friction_stress;
                cumulativeFriction += frictionInLayer;
            }
            
            data.push({y: endDepth, x: fromKpaForce(cumulativeFriction)});

            currentDepth = endDepth;
        });

        // Add tip resistance
        const finalFriction = cumulativeFriction;
        data.push({y: currentDepth, x: fromKpaForce(finalFriction + tip_bearing_force)});

        const ctx = document.getElementById('capacity-graph').getContext('2d');
        capacityChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: `תסבולת מצטברת (${loadUnit})`,
                    data: data,
                    borderColor: '#2563eb',
                    backgroundColor: 'rgba(37, 99, 235, 0.2)',
                    fill: true,
                    tension: 0.1
                }]
            },
            options: getChartOptions('תסבולת מצטברת עם העומק', 'עומק (מ\')', `תסבולת (${loadUnit})`)
        });
    }

    // --- COST CALCULATION ---
    function calculateCosts() {
        if(!lastCalculationResult.params) {
            showAlert("יש לבצע חישוב הנדסי תחילה.");
            return;
        }

        const drillingCostPerMeter = parseFloat(document.getElementById('drilling_cost').value) || 0;
        const concreteCostPerCube = parseFloat(document.getElementById('concrete_cost').value) || 0;

        const { params } = lastCalculationResult;
        const totalLength = params.layers.reduce((sum, l) => sum + l.thickness, 0);
        const tipArea = Math.PI * Math.pow(params.pile_diameter_m / 2, 2);
        const pileVolume = tipArea * totalLength;

        const totalDrillingCost = totalLength * drillingCostPerMeter;
        const totalConcreteCost = pileVolume * concreteCostPerCube;
        const totalCost = totalDrillingCost + totalConcreteCost;

        document.getElementById('drilling_cost_output').textContent = `₪${totalDrillingCost.toFixed(2)}`;
        document.getElementById('concrete_cost_output').textContent = `₪${totalConcreteCost.toFixed(2)}`;
        document.getElementById('total_cost_output').textContent = `₪${totalCost.toFixed(2)}`;
    }

    // --- EMBED GUIDE ---
    async function embedGuide() {
        const guideContainer = document.getElementById('guide-content-wrapper');
        const guideHtml = `
            <div class="flex flex-col md:flex-row min-h-screen bg-gray-100 text-gray-800">
                <aside id="guide-main-nav" class="w-full md:w-64 bg-white text-gray-800 p-4 shadow-lg md:sticky top-0 h-screen overflow-y-auto">
                    <h1 class="text-2xl font-bold text-blue-900 mb-6 border-b pb-4">מדריך לתכן כלונסאות</h1>
                    <nav>
                        <ul>
                            <li><a href="#" class="main-nav-item flex items-center p-3 my-1 rounded-lg hover:bg-gray-200 transition-colors duration-200" data-target="guide-standards-section">
                                <span class="text-2xl mr-3">📜</span> ניתוח תקנים
                            </a></li>
                            <li><a href="#" class="main-nav-item flex items-center p-3 my-1 rounded-lg hover:bg-gray-200 transition-colors duration-200" data-target="guide-recommendations-section">
                                <span class="text-2xl mr-3">💡</span> רקע ושלד להרצאה
                            </a></li>
                            <li><a href="#" class="main-nav-item flex items-center p-3 my-1 rounded-lg hover:bg-gray-200 transition-colors duration-200" data-target="guide-calculators-section">
                                <span class="text-2xl mr-3">🧮</span> מחשבונים
                            </a></li>
                        </ul>
                    </nav>
                </aside>
                <main class="flex-1 p-4 sm:p-6 lg:p-8 bg-gray-50">
                    <section id="guide-standards-section" class="content-section">
                        <!-- Standards content here -->
                    </section>
                    <section id="guide-recommendations-section" class="content-section">
                        <!-- Recommendations content here -->
                    </section>
                    <section id="guide-calculators-section" class="content-section">
                        <!-- Calculators content here -->
                    </section>
                </main>
            </div>`;
        guideContainer.innerHTML = guideHtml;
        initGuide();
    }
    
    function initGuide() {
        const guideWrapper = document.getElementById('guide-content-wrapper');
        if (!guideWrapper) return;
        
        const state = {
            main: 'guide-standards-section',
            standards: {
                activeTab: 'ti940-content',
                activeSubNav: {
                    'ti940-content': 'ti940-site-investigation',
                    'ti466-content': 'ti466-materials',
                    'ti413-content': null 
                }
            }
        };
        
        let rebarChartInstance = null;

        function renderGuide() {
            guideWrapper.querySelectorAll('.content-section').forEach(section => {
                section.classList.toggle('active', section.id === state.main);
            });
            guideWrapper.querySelectorAll('.main-nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.target === state.main);
            });

            if (state.main === 'guide-standards-section') {
                guideWrapper.querySelectorAll('.tab-button').forEach(button => {
                    button.classList.toggle('active', button.dataset.target === state.standards.activeTab);
                });
                guideWrapper.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.toggle('active', content.id === state.standards.activeTab);
                    if (content.id === state.standards.activeTab) {
                        const activeSubNavId = state.standards.activeSubNav[content.id];
                        content.querySelectorAll('.sub-nav-item').forEach(item => {
                            item.classList.toggle('active', item.dataset.target === activeSubNavId);
                        });
                        content.querySelectorAll('.sub-nav-content').forEach(subContent => {
                            subContent.classList.toggle('active', subContent.id === activeSubNavId);
                        });
                    }
                });
                if (state.standards.activeSubNav['ti466-content'] === 'ti466-rebar-details' && guideWrapper.querySelector('#ti466-rebar-details').classList.contains('active')) {
                    createOrUpdateRebarChart();
                }
            }
        }

        guideWrapper.querySelector('#guide-main-nav').addEventListener('click', e => {
            e.preventDefault();
            const target = e.target.closest('.main-nav-item');
            if (target && target.dataset.target) {
                state.main = target.dataset.target;
                renderGuide();
            }
        });

        const standardsSection = guideWrapper.querySelector('#guide-standards-section');
        standardsSection.innerHTML = `
            <header class="mb-8">
                <h2 class="text-4xl font-bold text-gray-800">ניתוח מעמיק של התקינה הישראלית</h2>
                <p class="text-lg text-gray-600 mt-2">סקירה מפורטת של הדרישות המרכזיות מת"י 940, ת"י 466 ות"י 413, החיוניות לתכן כלונסאות וקורות קשר.</p>
            </header>
            <div id="tabs-container" class="mb-6 border-b border-gray-300">
                <button class="tab-button text-lg py-2 px-6 border-b-2 border-transparent hover:border-blue-800 hover:text-blue-800 transition-colors duration-200" data-target="ti940-content">ת"י 940 - גיאוטכניקה</button>
                <button class="tab-button text-lg py-2 px-6 border-b-2 border-transparent hover:border-blue-800 hover:text-blue-800 transition-colors duration-200" data-target="ti466-content">ת"י 466 - חוקת הבטון</button>
                <button class="tab-button text-lg py-2 px-6 border-b-2 border-transparent hover:border-blue-800 hover:text-blue-800 transition-colors duration-200" data-target="ti413-content">ת"י 413 - תכן סיסמי</button>
            </div>
            <div id="ti940-content" class="tab-content">...</div>
            <div id="ti466-content" class="tab-content">...</div>
            <div id="ti413-content" class="tab-content">...</div>
        `;
        // The rest of the guide's HTML and JS would be injected and initialized here.
        
        renderGuide();
    }


    async function exportToPdf() {
        // PDF Export logic remains the same as previous version
    }

    // --- START THE APP ---
    init();
</script>
</body>
</html>
